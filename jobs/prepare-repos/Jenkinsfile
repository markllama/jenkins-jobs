//
// Create the repos needed to build OpenShift
//
// Expose properties for a parameterized build
properties(
    [
        buildDiscarder(
            logRotator(
                artifactDaysToKeepStr: '',
                artifactNumToKeepStr: '',
                daysToKeepStr: '',
                numToKeepStr: '1000')),
        [
            $class: 'ParametersDefinitionProperty',
            parameterDefinitions: [
                [
                    name: 'TARGET_NODE',
                    description: 'Jenkins agent node',
                    $class: 'hudson.model.StringParameterDefinition',
                    defaultValue: 'container'
                ],
                [
                    name: 'GITHUB_TOKEN_FILENAME',
                    description: 'The name of a file containing an OAuth token for API access',
                    $class: 'hudson.model.StringParameterDefinition',
                    defaultValue: '/jenkins/agent/.ssh/github-token-oauth.txt'
                ],

            ]
        ],
        disableConcurrentBuilds()
    ]
)

def read_oauth_token(token_file) {
    token_file = new File(token_file_name)
    //token_string = token_file.exists() ? token_file.getText().trim() : ""
    token_string = token_file.getText().trim()
    return token_string
}

// @param token_file - a file containing a single OAuth token string
// @return - a string containing the OAuth token
def read_oath_token_sh(token_file) {
    token_string = sh (
        returnStdout: true,
        script: "cat ${token_file}"
    ).trim()
    return token_string
}

// get a single file from a github repo

def get_single_file(owner, repo_name, file_name, repo_token) {
    // Get a single file from a Github repository.

    auth_header = "Authorization: token " + repo_token
    file_url = "https://api.github.com/repos/${owner}/${repo_name}/contents/${file_name}"
    accept_header = "Accept: application/vnd.github.v3.raw"
    query = "curl --silent -H '${auth_header}' -H '${accept_header}' -L ${file_url}"
    content = sh(
	      returnStdout: true,
        script: query
    )
    return content
}

def get_remote_branches() {
    return []
}

// get a list of branches from a remote github

node(TARGET_NODE) {

    token_file_name = GITHUB_TOKEN_FILENAME
    github_token = read_oauth_token(token_file_name)
    //
    // Given a version number to build, determmine how to configure the
    // local git workspacexz
    //
    stage("survey") {
        echo "BEGIN STAGE: survey"

        if (github_token == "") {
            error("failed to read file $token_file_name")
        }

        // 
        master_rpm_spec = get_single_file(
            'markllama', 'ose', 'origin.spec', github_token
        )

        echo master_rpm_spec
        
        //
        branches = get_remote_branches()

        echo "END STAGE: survey"
    }
}
